# Echo 시스템 예외 처리 규칙
# 특수 상황에서의 처리 방침과 폴백 전략

version: "1.0"
last_updated: "2025-01-12"

# 🚨 시스템 레벨 예외
system_exceptions:
  asyncio_issues:
    condition: "no running event loop"
    action: "lazy initialization 패턴 적용"
    fallback: "동기 모드로 전환"
    examples:
      - "MCP 서버 import 시점"
      - "엔진 초기화 단계"
    
  import_failures:
    condition: "required module not found"
    action: "graceful degradation"
    fallback: "mock/demo 모드"
    critical_modules:
      - transformers: "Mistral 기능 비활성화"
      - psutil: "성능 모니터링 스킵"
      - openai: "Claude API 사용 불가 알림"
    
  memory_constraints:
    condition: "insufficient memory"
    action: "리소스 사용량 제한"
    fallback: "배치 처리 + 샘플링"
    thresholds:
      - warning: "85% 메모리 사용"
      - critical: "95% 메모리 사용"

# 🔧 API 레벨 예외  
api_exceptions:
  external_api_failures:
    claude_api:
      timeout: 30
      retry_count: 3
      fallback: "llm_free_mode"
      error_patterns:
        - "rate limit exceeded": "지수 백오프 대기"
        - "authentication failed": "API 키 확인 요청"
        - "service unavailable": "로컬 모드 전환"
    
    mistral_local:
      timeout: 60
      retry_count: 1
      fallback: "template_based_response"
      error_patterns:
        - "model not found": "모델 경로 확인"
        - "cuda out of memory": "CPU 모드 전환"
        - "loading failed": "기본 템플릿 사용"
        
  mcp_communication:
    timeout: 10
    retry_count: 2
    fallback: "demo_response"
    error_patterns:
      - "connection refused": "MCP 서버 재시작 안내"
      - "protocol mismatch": "버전 호환성 확인"

# 📊 데이터 처리 예외
data_exceptions:
  file_operations:
    missing_files:
      config_files: "기본 설정으로 생성"
      template_files: "내장 템플릿 사용"
      data_files: "빈 데이터셋으로 시작"
      
    corrupted_files:
      yaml_parse_error: "JSON 형식으로 재시도"
      json_parse_error: "기본값으로 초기화"
      binary_corruption: "백업에서 복원"
      
  validation_failures:
    input_validation:
      type_mismatch: "타입 변환 시도"
      range_violation: "범위 내 값으로 클램핑"
      format_error: "기본 포맷으로 정규화"
      
    output_validation:
      schema_mismatch: "스키마 복구 시도"
      incomplete_response: "부분 응답 허용"
      malformed_json: "텍스트 형태로 반환"

# 🎭 시그니처 별 예외 처리
signature_exceptions:
  echo_aurora:
    creativity_blocks:
      condition: "창의적 아이디어 생성 실패"
      action: "감정적 접근으로 전환"
      fallback: "기존 성공 패턴 참조"
      
  echo_phoenix:
    change_resistance:
      condition: "변화 저항 감지"
      action: "점진적 접근으로 조정"
      fallback: "현상 유지 + 개선 포인트 제안"
      
  echo_sage:
    insufficient_data:
      condition: "분석할 데이터 부족"
      action: "추가 데이터 수집 요청"
      fallback: "제한된 정보 기반 가설 제시"
      
  echo_companion:
    conflict_situations:
      condition: "의견 대립 상황"
      action: "중재자 역할 수행"
      fallback: "각 관점의 장점 정리"

# 🔄 복구 전략
recovery_strategies:
  automatic_recovery:
    cache_corruption:
      steps:
        1: "캐시 무효화"
        2: "원본 데이터에서 재생성"
        3: "정합성 검증"
        
    service_degradation:
      steps:
        1: "비핵심 기능 비활성화"
        2: "리소스 집중화"
        3: "점진적 기능 복원"
        
  manual_intervention:
    critical_failures:
      notification: "관리자에게 즉시 알림"
      documentation: "실패 상황 상세 로깅"
      guidance: "사용자 대안 제시"
      
    configuration_issues:
      validation: "설정 파일 검증"
      backup: "기본 설정으로 복원"
      migration: "호환 버전으로 변환"

# 📝 로깅 및 모니터링
monitoring_exceptions:
  log_levels:
    debug: "개발 디버깅 정보"
    info: "정상 운영 상황"
    warning: "주의 필요 상황"
    error: "오류 발생 상황"
    critical: "즉시 대응 필요"
    
  alerting_rules:
    high_frequency_errors:
      threshold: "분당 10회 이상"
      action: "자동 재시작 고려"
      
    resource_exhaustion:
      threshold: "90% 이상 사용"
      action: "리소스 해제 시도"
      
    service_unavailability:
      threshold: "5분 이상 무응답"
      action: "헬스체크 강화"

# 🧪 테스트 환경 예외
testing_exceptions:
  mock_mode_fallbacks:
    engine_unavailable: "demo_responses.json 사용"
    api_unreachable: "static_test_data.yaml 사용"
    performance_tests: "baseline_benchmarks.json 사용"
    
  ci_cd_adaptations:
    timeout_adjustments:
      - "벤치마크: 2분 → 10초"
      - "모델 로딩: 5분 → 스킵"
      - "외부 API: 30초 → 5초"
      
    resource_limitations:
      - "메모리 사용량 제한"
      - "CPU 코어 수 제한"
      - "디스크 I/O 최소화"